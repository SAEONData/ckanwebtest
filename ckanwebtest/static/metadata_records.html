<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Metadata Records</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">

        function load_lookup(url, select) {
            $.ajax({
                url: url,
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: "{}",
                success: function (result) {
                    for(var i = 0; i < result.length; i++) {
                        var opt = result[i];
                        var el = document.createElement("option");
                        el.textContent = opt;
                        el.value = opt;
                        select.appendChild(el);
                    }
                },
                error: function (call, state, msg) {
                    select.firstChild.textContent = "Error loading objects";
                }
            });
        }

        function load_lookups() {
            load_lookup("/action/organization_list", document.getElementById("organization"));
            load_lookup("/action/infrastructure_list", document.getElementById("infrastructures"));
            load_lookup("/action/metadata_collection_list", document.getElementById("metadata_collection"));
            load_lookup("/action/metadata_standard_list", document.getElementById("metadata_standard"));
            load_lookup("/action/organization_list", document.getElementById("organization_filter"));
            load_lookup("/action/infrastructure_list", document.getElementById("infrastructure_filter"));
            load_lookup("/action/metadata_collection_list", document.getElementById("metadata_collection_filter"));
            load_lookup("/action/metadata_record_list", document.getElementById("metadata_record_filter"));
            load_lookup("/action/metadata_model_list", document.getElementById("metadata_model"));
        }

        window.onload = load_lookups;

        function list_() {
            $("#response").val("Loading metadata record list...");
            $.ajax({
                url: "/action/metadata_record_list",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "all_fields": $("#all_fields").prop("checked"),
                    "ids": $("#metadata_record_filter").val(),
                    "owner_org": $("#organization_filter").val(),
                    "infrastructure_id": $("#infrastructure_filter").val(),
                    "metadata_collection_id": $("#metadata_collection_filter").val(),
                }),
                success: function (result) {
                    $("#response").val(JSON.stringify(result, null, 4));
                },
                error: function (call, state, msg) {
                    $("#response").val(msg);
                }
            });
        }

        function view() {
            $("#response").val("Fetching metadata record...");
            $.ajax({
                url: "/action/metadata_record_show",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "id": $("#name").val(),
                }),
                success: function (result) {
                    $("#response").val(JSON.stringify(result, null, 4));
                },
                error: function (call, state, msg) {
                    $("#response").val(msg);
                }
            });
        }

        function get_infrastructures() {
            var infrastructures = [];
            var infrastructure_names = $("#infrastructures").val();
            for (var i = 0; i < infrastructure_names.length; i++) {
                infrastructures.push({"id": infrastructure_names[i]});
            }
            return infrastructures;
        }

        function create() {
            $("#response").val("Creating metadata record...");
            $.ajax({
                url: "/action/metadata_record_create",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "title": $("#title").val(),
                    "owner_org": $("#organization").val(),
                    "metadata_collection_id": $("#metadata_collection").val(),
                    "infrastructures": get_infrastructures(),
                    "metadata_standard_id": $("#metadata_standard").val(),
                    "metadata_json": $("#metadata_json").val(),
                    "metadata_raw": "",
                    "metadata_url": "",
                }),
                success: function (result) {
                    $("#response").val(JSON.stringify(result, null, 4));
                },
                error: function (call, state, msg) {
                    $("#response").val(msg);
                }
            });
        }

        function update() {
            $("#response").val("Updating metadata record...");
            $.ajax({
                url: "/action/metadata_record_update",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "id": $("#name").val(),
                    "title": $("#title").val(),
                    "owner_org": $("#organization").val(),
                    "metadata_collection_id": $("#metadata_collection").val(),
                    "infrastructures": get_infrastructures(),
                    "metadata_standard_id": $("#metadata_standard").val(),
                    "metadata_json": $("#metadata_json").val(),
                    "metadata_raw": "",
                    "metadata_url": "",
                }),
                success: function (result) {
                    $("#response").val(JSON.stringify(result, null, 4));
                },
                error: function (call, state, msg) {
                    $("#response").val(msg);
                }
            });
        }

        function delete_() {
            $("#response").val("Deleting metadata record...");
            $.ajax({
                url: "/action/metadata_record_delete",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "id": $("#name").val(),
                }),
                success: function (result) {
                    $("#response").val(JSON.stringify(result, null, 4));
                },
                error: function (call, state, msg) {
                    $("#response").val(msg);
                }
            });
        }

        function validate() {
            $("#response").val("Validating metadata record...");
            $.ajax({
                url: "/action/metadata_record_validate",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "id": $("#name").val(),
                }),
                success: function (result) {
                    $("#response").val(JSON.stringify(result, null, 4));
                },
                error: function (call, state, msg) {
                    $("#response").val(msg);
                }
            });
        }

        function invalidate() {
            $("#response").val("Invalidating metadata record...");
            $.ajax({
                url: "/action/metadata_record_invalidate",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "id": $("#name").val(),
                }),
                success: function (result) {
                    $("#response").val(JSON.stringify(result, null, 4));
                },
                error: function (call, state, msg) {
                    $("#response").val(msg);
                }
            });
        }

        function check_validity() {
            $("#response").val("Checking validity of metadata...");
            $.ajax({
                url: "/action/metadata_validity_check",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "model_json": $("#model_json").val(),
                    "metadata_json": $("#metadata_json").val(),
                }),
                success: function (result) {
                    $("#response").val(JSON.stringify(result, null, 4));
                },
                error: function (call, state, msg) {
                    $("#response").val(msg);
                }
            });
        }

        function load_metadata_model() {
            $("#model_json").val("Loading metadata model JSON...");
            $.ajax({
                url: "/action/metadata_model_show",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "id": $("#metadata_model").val(),
                }),
                success: function (result) {
                    $("#model_json").val(JSON.stringify(result.model_json, null, 4));
                },
                error: function (call, state, msg) {
                    $("#model_json").val(msg);
                }
            });
        }
    </script>
</head>
<body>
    <b>Manage Metadata Records</b>
    <table>
        <tr><td>Name:</td><td><input type="text" id="name"/> (auto-generated on create)</td></tr>
        <tr><td>Title:</td><td><input type="text" id="title"/></td></tr>
        <tr><td>Organization:</td><td><select id="organization"><option value="">(None)</option></select> *</td></tr>
        <tr><td>Metadata Collection:</td><td><select id="metadata_collection"><option value="">(None)</option></select> *</td></tr>
        <tr><td>Infrastructures:</td><td><select multiple id="infrastructures"></select> (select zero or more)</td></tr>
        <tr><td>Metadata Standard:</td><td><select id="metadata_standard"><option value="">(None)</option></select> *</td></tr>
        <tr><td>Metadata JSON:</td><td>
            <textarea id="metadata_json" style="width: 800px; height: 400px">SAMPLE_METADATA_JSON</textarea>
        </td><td>
            <textarea id="model_json" style="width: 800px; height: 400px"></textarea>
        </td></tr>
        <tr><td>Submit:</td><td>
            <input type="button" value="Create" onclick="create();"/>
            <input type="button" value="Update" onclick="update();"/>
            <input type="button" value="Delete" onclick="delete_();"/>
            <input type="button" value="View" onclick="view();"/>
            <input type="button" value="Validate" onclick="validate();"/>
            <input type="button" value="Invalidate" onclick="invalidate();"/>
            </td><td>
                <select id="metadata_model" onchange="load_metadata_model();"><option value="">Load Metadata Model</option></select>
                <input type="button" value="Check Validity" onclick="check_validity();"/>
            </td></tr>
        <tr><td></td><td>
            <input type="button" value="List All" onclick="list_();"/>
            <input type="checkbox" id="all_fields"/> All fields
            <select id="organization_filter"><option value="">Filter by Organization</option></select>
            <select id="infrastructure_filter"><option value="">Filter by Infrastructure</option></select>
            <select id="metadata_collection_filter"><option value="">Filter by Collection</option></select>
        </td></tr>
        <tr><td></td><td>
            <select multiple id="metadata_record_filter"></select> Filter by ID(s)
        </td></tr>
        <tr><td>Response:</td><td><textarea readonly id="response" style="width: 800px; height: 600px"></textarea></td></tr>
    </table>
</body>
</html>
